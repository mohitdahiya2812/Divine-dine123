<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Divine Dine</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body { font-family: Arial; margin:0; background:#f4f4f4; }
header { background:#111; color:white; padding:15px; text-align:center; }
button { padding:8px 12px; margin:5px; cursor:pointer; }
.card { background:white; padding:15px; margin:10px; border-radius:8px; }
.cart { background:white; padding:15px; margin:10px; border-radius:8px; }
.admin-btn { position:fixed; top:10px; right:10px; background:black; color:white; }
input { padding:6px; margin:5px 0; width:100%; }
</style>
</head>

<body>

<header>Divine Dine</header>
<button class="admin-btn" onclick="renderAdmin()">Admin</button>
<div id="app"></div>

<script>

const supabaseUrl = "https://ivvsoqjnzlxmgthfscer.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml2dnNvcWpuemx4bWd0aGZzY2VyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NDMwMTAsImV4cCI6MjA4NzAxOTAxMH0.rfJ_31yC5iKcRrfMWndJbOT5-EaKdAtFUy9KGaz1Mow";

const sb = supabase.createClient(supabaseUrl, supabaseKey);

let cart = [];
let discountAmount = 0;

/* LOAD CUSTOMER MENU BY DEFAULT */
async function renderCustomer() {

  const { data, error } = await sb.from("menu").select("*");

  if (error) {
    document.getElementById("app").innerHTML = "Error loading menu";
    console.log(error);
    return;
  }

  let html = `<h2 style="padding-left:10px;">Menu</h2>`;

  if (!data || data.length === 0) {
    html += `<p style="padding:10px;">No items available</p>`;
  } else {
    data.forEach(item => {
      if (!item.is_available) return;

      html += `
        <div class="card">
          <h3>${item.name}</h3>
          <p>₹ ${item.price}</p>
          <button onclick="addToCart(${item.id}, '${item.name}', ${item.price})">
            Add
          </button>
        </div>
      `;
    });
  }

  html += `<div class="cart">${renderCart()}</div>`;

  document.getElementById("app").innerHTML = html;
}

function addToCart(id, name, price) {
  cart.push({ id, name, price });
  renderCustomer();
}

function renderCart() {

  if (cart.length === 0) return "Cart empty";

  let total = cart.reduce((sum, i) => sum + i.price, 0);
  let finalTotal = total - discountAmount;

  return `
    ${cart.map(i => `<p>${i.name} - ₹${i.price}</p>`).join("")}
    <hr>
    <b>Total: ₹${total}</b><br>
    <b>Discount: ₹${discountAmount}</b><br>
    <b>Payable: ₹${finalTotal}</b><br><br>

    <input id="couponInput" placeholder="Enter Coupon Code">
    <button onclick="applyCoupon()">Apply Coupon</button>
    <br><br>

    <button onclick="placeOrder()">Proceed to Pay</button>
  `;
}

async function applyCoupon() {

  let code = document.getElementById("couponInput").value.trim();

  const { data } = await sb
    .from("coupons")
    .select("*")
    .eq("code", code)
    .eq("is_active", true)
    .single();

  if (!data) {
    alert("Invalid Coupon");
    return;
  }

  let total = cart.reduce((sum, i) => sum + i.price, 0);
  discountAmount = Math.floor(total * 0.1);

  alert("Coupon Applied!");
  renderCustomer();
}

async function placeOrder() {

  if (cart.length === 0) {
    alert("Cart empty");
    return;
  }

  let total = cart.reduce((sum, i) => sum + i.price, 0);
  let finalTotal = total - discountAmount;

  const { error } = await sb.from("orders1").insert([
    { total_amount: finalTotal }
  ]);

  if (error) {
    alert("Order saving failed");
    console.log(error);
    return;
  }

  alert("Order Placed Successfully!");
  cart = [];
  discountAmount = 0;
  renderCustomer();
}

/* ADMIN PANEL */
function renderAdmin() {

  document.getElementById("app").innerHTML = `
    <h2 style="padding-left:10px;">Admin Panel</h2>

    <button onclick="showSales()">Total Sales</button>
    <button onclick="showOrders()">Total Orders</button>
    <button onclick="renderCustomer()">Back to Customer</button>

    <div id="adminData" style="margin-top:20px;padding:10px;"></div>
  `;
}

async function showSales() {

  const { data } = await sb.from("orders1").select("total_amount");

  let total = 0;
  if (data) {
    data.forEach(o => total += o.total_amount);
  }

  document.getElementById("adminData").innerHTML =
    `<h3>Total Sales</h3><p>₹ ${total}</p>`;
}

async function showOrders() {

  const { data } = await sb.from("orders1").select("id");

  document.getElementById("adminData").innerHTML =
    `<h3>Total Orders</h3><p>${data ? data.length : 0}</p>`;
}

/* INITIAL LOAD */
renderCustomer();

</script>

</body>
</html>
